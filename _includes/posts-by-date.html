<div class="posts-by-date">
    {% for post in site.posts  %}
        {% capture year %}{{ post.date | date: "%Y" }}{% endcapture %}
        {% capture month %}{{ post.date | date: "%B" }}{% endcapture %}

        {% capture next_year %}{{ post.next.date | date: "%Y" }}{% endcapture %}
        {% capture next_month %}{{ post.next.date | date: "%B" }}{% endcapture %}

        {% if year != next_year %}
            {% assign is_year_printed = true %}
        {% else %}
            {% assign is_year_printed = false %}
        {% endif %}

        {% if month != next_month %}
            {% assign is_month_printed = true %}
        {% else %}
            {% assign is_month_printed = false %}
        {% endif %}

        {% if forloop.first %}
            <dl>
                <dt class="year">{{year}}</dt>
                <dd>
                    <dl>
                        <dt class="month">{{ month }}</dt>
        {% elsif !is_year_printed %}
                    </dl>
                </dd>
                <dt class="year">{{year}}</dt>
                <dd>
                    <dl>
                        <dt class="month">{{ month }}</dt> <!-- we need this in case months posts are a year apart -->
        {% elsif !is_month_printed %}
                        <dt class="month">{{ month }}</dt>
        {% endif %}
                            <dd><a href="{{ site.baseurl}}{{ post.url }}">{{ post.title }}</a></dd>
        {% if forloop.last %}
                    </dl>
                </dd>
            </dl>
        {% endif %}
    {% endfor %}
</div>